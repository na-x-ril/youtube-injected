class TikTokUtils{static $(e){return document.querySelector(e)}static $$(e){return document.querySelectorAll(e)}static wait(e){return new Promise(t=>setTimeout(t,e))}}class VideoHandler{constructor(){this.previousVideoURL=null,this.isSpeedUp=!1,this.originalPlaybackRate=null,this.addedKeyListeners=!1,this.initializeClock(),this.setupFetchToggle(),this.observeVideos(),this.mainLoop()}async mainLoop(){for(;;)this.setupFetchToggle(),this.initializeClock(),this.handleVideoChange(),await TikTokUtils.wait(100)}handleVideoChange(){const e=location.href;this.previousVideoURL===e||/\/(setting|messages)/.test(location.pathname)||(this.previousVideoURL=e,this.setupCommentToggle(),this.initializeTimers(),this.setupShortcuts())}setupCommentToggle(){new Promise(e=>{const t=()=>{const i=TikTokUtils.$$('[class*="1gjo2yl-DivPostButton"]');i.length>0?e(i):requestAnimationFrame(t)};t()}).then(e=>{e.forEach(e=>{e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24"><path fill="white" d="m3.4 20.4l17.45-7.48a1 1 0 0 0 0-1.84L3.4 3.6a.993.993 0 0 0-1.39.91L2 9.12c0 .5.37.93.87.99L17 12L2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91"/></svg>'})})}initializeTimers(){TikTokUtils.$$('div[id*="xgwrapper"] > video:not([timer-initialized])').forEach(e=>{this.initializeVideo(e)})}initializeVideo(e){/playback1/.test(e.getAttribute("src")||"")?e.remove():(new VideoTimer(e),e.setAttribute("timer-initialized",""))}observeVideos(){new Promise(e=>{const t=()=>{const i=TikTokUtils.$("video:not([timer-initialized])");i?e(i):requestAnimationFrame(t)};t()}).then(e=>{this.initializeVideo(e),this.observeVideos()})}setupShortcuts(){this.addedKeyListeners||(document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("keyup",e=>this.handleKeyUp(e)),this.addedKeyListeners=!0)}handleKeyDown(e){if(/\/photo/.test(location.pathname))return;const t=TikTokUtils.$('div[id*="xgwrapper"] > video:not([src*="playback1"])'),i="INPUT"===document.activeElement?.tagName,n=document.activeElement===TikTokUtils.$('div[class*="zqqb1u-DivSearchBarContainer"] input'),s=!!TikTokUtils.$('[class*="10hhkxy-DivInputAreaContainer"]');if(!(i||s||n)&&t)switch(e.key){case"k":this.toggleCommentAndSearch(),e.preventDefault();break;case"ArrowLeft":t&&(t.currentTime=Math.max(t.currentTime-3,0)),this.createSkipIndicator("left",3);break;case"ArrowRight":t&&(t.currentTime=Math.min(t.currentTime+3,t.duration)),this.createSkipIndicator("right",3);break;case",":t&&(t.currentTime=Math.max(t.currentTime-5,0)),this.createSkipIndicator("left",5),e.preventDefault();break;case".":t&&(t.currentTime=Math.min(t.currentTime+5,t.duration)),this.createSkipIndicator("right",5),e.preventDefault();break;case"n":t&&!this.isSpeedUp&&(this.originalPlaybackRate=t.playbackRate,t.playbackRate=2,this.isSpeedUp=!0);break;case"p":t&&(t.paused?t.play():t.pause()),e.preventDefault();break;case"s":this.saveButton(t),e.preventDefault();break;case"/":if(this.focusSearch())return void e.preventDefault();break;case"Escape":if(this.unfocusSearch())return void e.preventDefault()}}saveButton(e){let t;const i=!!TikTokUtils.$('[class*="tp15oe-DivBrowserModeContainer"]'),n=!!TikTokUtils.$('[class*="DivContentFlexLayout"]');i?t=e.closest('[class*="tp15oe-DivBrowserModeContainer"]').querySelector('[class*="1d39a26-DivFlexCenterRow"] > div > button'):n&&(t=e.closest('[class*="DivContentFlexLayout"]').querySelector('[class*="67yy18-ButtonActionItem"][aria-label*="Favorites"]')),t&&t.click(),this.waitForManageButton().then(e=>{e&&(e.focus(),document.addEventListener("keydown",t=>this.handleManageKeyDown(t,e)))})}waitForManageButton(){return new Promise(e=>{const t=()=>{const i=TikTokUtils.$('button[aria-label="Manage"]');i?e(i):requestAnimationFrame(t)};t()})}handleManageKeyDown(e,t){"Enter"===e.key&&(t.click(),document.removeEventListener("keydown",this.handleManageKeyDown))}handleKeyUp(e){if(!/\/photo/.test(location.pathname)&&"n"===e.key&&this.isSpeedUp){const e=TikTokUtils.$('div[id*="xgwrapper"] > video:not([src*="playback1"])');e&&(e.playbackRate=this.originalPlaybackRate||1,this.isSpeedUp=!1)}}toggleCommentAndSearch(){const e=TikTokUtils.$('[class*="1qjw4dg-DivContentContainer"]')||TikTokUtils.$('[class*="ibh9b5-DivContentContainer"]');if(e){const t="none"===e.style.display?"flex":"none";e.style.display=t}}focusSearch(){try{const e=location.pathname;if(!/\/(foryou|search)/.test(e))return!1;const t=TikTokUtils.$('[class*="m8ow1x-DivFixedContentContainer"] > [class*="1icvwlp-DivSearchWrapper"] > button');return!!(t&&t instanceof HTMLButtonElement)&&(t.click(),!0)}catch(e){return console.error("Error focusing search:",e),!1}}unfocusSearch(){try{const e=TikTokUtils.$('[class*="3z2zs6-DivHeaderCenterContainer"] > div > form > input');return document.activeElement===e&&(e.blur(),!0)}catch(e){return console.error("Error unfocusing search:",e),!1}}createSkipIndicator(e,t){const i=TikTokUtils.$('video:not([src*="playback1"])');if(!i)return;TikTokUtils.$$(".skip-indicator").forEach(e=>e.remove());const n=i.parentElement;if(!n)return;const s=document.createElement("div");s.className=`skip-indicator ${e}`,s.textContent=`${t}s ${"left"===e?"◀◀":"▶▶"}`,n.appendChild(s),s.offsetHeight,s.classList.add("show"),setTimeout(()=>{s.remove()},680)}initializeClock(){new Promise(e=>{const t=()=>{const i=TikTokUtils.$('[class*="q8q040-DivHeaderRightContainer"]');i?e(i):requestAnimationFrame(t)};t()}).then(e=>{if(TikTokUtils.$(".header-clock"))return;const t=new Date,i=document.createElement("div");i.className="header-clock";const n=document.createElement("div");n.className="clock-digits",n.innerHTML=t.getHours().toString().padStart(2,"0");const s=document.createElement("div");s.className="clock-digits",s.innerHTML=t.getMinutes().toString().padStart(2,"0");const o=document.createElement("span");o.textContent=":",i.appendChild(n),i.appendChild(o),i.appendChild(s),e.insertAdjacentElement("afterbegin",i);const a=()=>{const e=new Date;n.innerHTML=e.getHours().toString().padStart(2,"0"),s.innerHTML=e.getMinutes().toString().padStart(2,"0")};a(),setInterval(a,1e3)})}setupFetchToggle(){new Promise(e=>{const t=()=>{const i=TikTokUtils.$('[class*="q8q040-DivHeaderRightContainer"]');i?e(i):requestAnimationFrame(t)};t()}).then(e=>{if(!TikTokUtils.$("#toggle-fetch-input")){const t=document.createElement("button");if(t.id="toggle-fetch-input",t.className="style-scope toggle-fetch",t.setAttribute("alt","Toggle Fetch Input"),t.setAttribute("title","Spam Web Request"),t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="1.6em" height="1.6em" viewBox="0 0 14 14">\n            <path fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" d="m.5 10.5l10-10H6m7.5 3l-10 10H8" />\n          </svg>\n        ',e.insertAdjacentElement("afterbegin",t),!TikTokUtils.$("#fetch-popup")){const e=document.createElement("div");e.id="fetch-popup",e.className="fetch-popup",e.style.display="none",e.innerHTML=`\n            <div class="fetch-popup-content">\n              <h3>Custom Fetch Configuration</h3>\n              <div class="fetch-input-group">\n                <label for="fetch-input">Fetch URL<span id="url-validation-message">*Invalid Fetch</span></label>\n                <input type="text" id="fetch-input" placeholder="Enter fetch URL..." autocomplete="off">\n              </div>\n              <div class="fetch-input-group">\n                <label for="fetch-interval">Interval (ms)<span id="interval-validation-message">*Invalid number</span></label>\n                <input type="number" id="fetch-interval" placeholder="Enter interval..." value="${localStorage.getItem("fetchInterval")||""}">\n              </div>\n              <div class="fetch-buttons">\n                <button id="submit-fetch">Start Fetch</button>\n                <button id="stop-fetch" style="display: none;">Stop Fetch</button>\n                <button id="close-popup">Close</button>\n              </div>\n            </div>\n          `,document.body.appendChild(e),document.addEventListener("keydown",e=>{"Escape"===e.key&&"block"===TikTokUtils.$("#fetch-popup").style.display?TikTokUtils.$("#fetch-popup").style.display="none":"Enter"===e.key&&"block"===TikTokUtils.$("#fetch-popup").style.display&&TikTokUtils.$("#submit-fetch").click()}),this.setupFetchPopupListeners()}}})}setupFetchPopupListeners(){TikTokUtils.$("#toggle-fetch-input").addEventListener("click",()=>{TikTokUtils.$("#fetch-popup").style.display="block"}),TikTokUtils.$("#close-popup").addEventListener("click",()=>{TikTokUtils.$("#fetch-popup").style.display="none"}),TikTokUtils.$("#fetch-popup").addEventListener("click",e=>{e.target===TikTokUtils.$("#fetch-popup")&&(TikTokUtils.$("#fetch-popup").style.display="none")});const savedInterval=localStorage.getItem("spamInterval");savedInterval&&(TikTokUtils.$("#fetch-interval").value=savedInterval),TikTokUtils.$("#submit-fetch").addEventListener("click",()=>{const fetchCode=TikTokUtils.$("#fetch-input").value.trim(),intervalValue=TikTokUtils.$("#fetch-interval").value,urlMessage=TikTokUtils.$("#url-validation-message"),intervalMessage=TikTokUtils.$("#interval-validation-message"),urlRegex=/^fetch.*https:\/\//,isIntervalValid=/^\d+$/.test(intervalValue)&&parseInt(intervalValue,10)>0;return urlRegex.test(fetchCode)||isIntervalValid?urlRegex.test(fetchCode)?isIntervalValid?(urlMessage.style.display="none",intervalMessage.style.display="none",localStorage.setItem("spamInterval",intervalValue),window.fetchInterval&&clearInterval(window.fetchInterval),window.fetchInterval=setInterval(()=>{try{eval(fetchCode)}catch(e){console.error("Error executing fetch code:",e)}},parseInt(intervalValue)),TikTokUtils.$("#stop-fetch").style.display="inline-block",void(TikTokUtils.$("#submit-fetch").style.display="none")):(urlMessage.style.display="none",void(intervalMessage.style.display="block")):(urlMessage.style.display="block",void(intervalMessage.style.display="none")):(urlMessage.style.display="block",void(intervalMessage.style.display="block"))}),TikTokUtils.$("#stop-fetch").addEventListener("click",()=>{window.fetchInterval&&(clearInterval(window.fetchInterval),window.fetchInterval=null,console.info("Fetch interval stopped"),TikTokUtils.$("#submit-fetch").style.display="inline-block",TikTokUtils.$("#stop-fetch").style.display="none")})}}class VideoTimer{constructor(e){this.videoElement=e,this.timerContainer=null,this.liveText=null,this.currentTime=null,this.seekBar=null,this.lastCurrentTime=null,this.init()}waitForVideoWrapper(){return new Promise(e=>{const t=location.pathname,i={"/":'[class*="zpbg2p-ArticleItemContainer"]',"/foryou":'[class*="zpbg2p-ArticleItemContainer"]',"/video":'[class*="SectionMediaCardContainer"]',"/search":'[class*="1j167yi-DivWrapper"]'},n=Object.keys(i).find(e=>t.includes(e))?i[Object.keys(i).find(e=>t.includes(e))]:null;if(!n)return console.warn("No matching wrapper selector for the current path:",t),void e(null);const s=()=>{const t=this.videoElement?.closest(n);t?e(t):requestAnimationFrame(s)};s()})}generateTikTokUrl(e){if(!e)return Promise.resolve(null);const t=location.pathname;if(t.includes("/foryou")||"/"===t)return new Promise(t=>{const i=()=>{const n=e?.querySelector('a[class*="iw4mtl-H3AuthorTitle"]');if(n){const i=n.getAttribute("href"),s=e?.querySelector('div[id*="xgwrapper"]');if(s){const e=`https://www.tiktok.com${i}/video/${s.id.split("-").pop()}`;console.log("Generated TikTok URL:",e),t(e)}else console.warn("xgwrapper not found in foryou path"),t(null)}else requestAnimationFrame(i)};i()});if(t.includes("/search")){const t=e?.querySelector('a[href*="/video/"]');if(t){const e=t.getAttribute("href");return console.log("Generated TikTok URL:",e),Promise.resolve(e)}return console.warn("Video link element not found in search path"),Promise.resolve(null)}if(t.includes("/video")){const t=e?.querySelector('p[data-e2e="browse-video-link"]');if(t){const e=t.innerText.trim().split("?")[0];return console.log("Generated TikTok URL:",e),Promise.resolve(e)}return console.warn("Browse video link element not found in video path"),Promise.resolve(null)}return console.warn("No matching path for the current URL:",t),Promise.resolve(null)}init(){this.createTimer(),this.updateTimer(),this.addEventListeners()}createTimer(){this.timerContainer||(this.timerContainer=document.createElement("div"),this.timerContainer.className="video-timer",this.liveText=document.createElement("span"),this.liveText.className="live-text",this.currentTime=document.createElement("span"),this.currentTime.className="current-time",this.seekBar=document.createElement("input"),this.seekBar.type="range",this.seekBar.min=0,this.seekBar.max=100,this.seekBar.value=0,this.seekBar.className="video-seekbar",this.timerContainer.appendChild(this.liveText),this.timerContainer.appendChild(this.currentTime),this.videoElement.parentElement?.appendChild(this.timerContainer),this.videoElement.parentElement?.appendChild(this.seekBar))}updateTimer(){if(!this.videoElement.duration)return;if(this.videoElement.duration===1/0){const e=TikTokUtils.$('[class*="1rybbwv-DivOpeningTimerLabel"] > div');return this.liveText.textContent="LIVE",this.liveText.style.display="inline-block",void(this.currentTime.textContent=e?e.textContent:"")}this.liveText.style.display="none";const e=this.videoElement.currentTime;if(e===this.lastCurrentTime)return;this.lastCurrentTime=e;const t=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;this.currentTime.textContent=`${t(e)} / ${t(this.videoElement.duration)}`;const i=e/this.videoElement.duration*100;this.seekBar.value=i,this.seekBar.style.setProperty("--progress-percent",`${i}%`)}unmute(){this.videoElement.muted=!1}loop(){this.videoElement.loop=!0,this.videoElement.setAttribute("autoplay","")}setupGainNode(){location.pathname.match(/\/@[\w]+/)&&!/\/(setting|messages)/.test(location.pathname)||fetch("https://cdn.jsdelivr.net/gh/na-x-ril/audio-gain/gainNode.js").then(e=>{e.ok?console.log("GainNode setup success!"):console.error("GainNode setup failed!")}).catch(e=>console.error("Fetch error:",e))}addEventListeners(){this.videoElement.addEventListener("play",()=>{this.updateTimer(),this.setupGainNode(),this.unmute(),this.loop(),console.log("Video playing:",this.videoElement),this.waitForVideoWrapper().then(e=>this.generateTikTokUrl(e))}),this.videoElement.addEventListener("timeupdate",()=>this.updateTimer()),this.seekBar.addEventListener("input",e=>{const t=e.target.value/100*this.videoElement.duration;this.videoElement.currentTime=t})}}new VideoHandler;